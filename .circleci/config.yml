version: 2.1

jobs:
  build:
    docker:
      - image: circleci/openjdk:11-jdk-stretch

    steps:
      - checkout

      - restore_cache:
          key: circleci-jnote{{ checksum "pom.xml" }}

      - run:
          name: test jnote
          command: mvn test

      - save_cache:
          paths:
            ~/.m2
          key: circleci-jnote{{ checksum "pom.xml" }}

  build-installer:
    machine:
      image: "windows-server-2019-vs2019:stable"
      resource_class: "windows.medium"
      shell: bash.exe
    steps:
      - checkout

      - restore_cache:
          key: circleci-jnote_packages{{ checksum "install_dependencies.sh" }}

      - run:
          name: download jdk 14
          command: ./download_jdk.sh

      - run:
          name: unzip jdk
          command: ./unzip_jdk.sh

release-filter: &release-filter
  filters:
    # ignore any commit on any branch by default
    branches:
      ignore: /.*/
    # only act on version tags
    tags:
      only: /^v\d+\.\d+\.\d+$/

workflows:
  version: 2
  build_release:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
      - build-installer:
          <<: *release-filter
          requires:
            - build